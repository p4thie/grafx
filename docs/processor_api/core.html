<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="grafx.processors.filter" href="filter.html" /><link rel="prev" title="grafx.utils" href="../graph_api/utils.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 7.4.7 and Furo 2024.07.18 -->
        <title>grafx.processors.core - GRAFX Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=613ab9ff" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=a6743078" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">GRAFX Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">GRAFX Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction/graph.html">Audio Processing Graphs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/processors.html">Differentiable Processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/render.html">Batched Audio Processing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Graph API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../graph_api/data.html">grafx.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../graph_api/render.html">grafx.render</a></li>
<li class="toctree-l1"><a class="reference internal" href="../graph_api/draw.html">grafx.draw</a></li>
<li class="toctree-l1"><a class="reference internal" href="../graph_api/utils.html">grafx.utils</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Processor API</span></p>
<ul class="current">
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">grafx.processors.core</a></li>
<li class="toctree-l1"><a class="reference internal" href="filter.html">grafx.processors.filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="eq.html">grafx.processors.eq</a></li>
<li class="toctree-l1"><a class="reference internal" href="stereo.html">grafx.processors.stereo</a></li>
<li class="toctree-l1"><a class="reference internal" href="dynamics.html">grafx.processors.dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="nonlinear.html">grafx.processors.nonlinear</a></li>
<li class="toctree-l1"><a class="reference internal" href="reverb.html">grafx.processors.reverb</a></li>
<li class="toctree-l1"><a class="reference internal" href="delay.html">grafx.processors.delay</a></li>
<li class="toctree-l1"><a class="reference internal" href="container.html">grafx.processors.container</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references/history.html">Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/reference.html">References</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="grafx-processors-core">
<h1>grafx.processors.core<a class="headerlink" href="#grafx-processors-core" title="Link to this heading"></a></h1>
<dl class="py class">
<dt class="sig sig-object py" id="grafx.processors.core.convolution.FIRConvolution">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">FIRConvolution</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">mode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'causal'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flashfftconv</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_input_len</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">131072</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.convolution.FIRConvolution" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>A FIR convolution backend, which can use either native FFT-based convolution or <code class="code highlight python docutils literal highlight-python"><span class="n">FlashFFTConv</span></code> <span id="id1">[<a class="reference internal" href="../references/reference.html#id149" title="Daniel Y Fu, Hermann Kumbong, Eric Nguyen, and Christopher Ré. FlashFFTConv: efficient convolutions for long sequences with tensor cores. ICLR, 2023.">FKNRe23</a>]</span>.
Allows for causal and zero-phase convolution modes.</p>
<blockquote>
<div><p>For an input <span class="math notranslate nohighlight">\(\mathbf{U}\in\mathbb{R}^{B\times C_{\mathrm{in}} \times L_{\mathrm{in}}}\)</span>
and a filter <span class="math notranslate nohighlight">\(\mathbf{U}\in\mathbb{R}^{B\times C_{\mathrm{filter}} \times L_{\mathrm{filter}}}\)</span>
the operation is defined as a usual convolution. However, the output length will be the one of the input
and the number of the output channels will be determined by broadcasting.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>mode</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">str</span></code>, <em>optional</em>) – The convolution mode, either <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;causal&quot;</span></code> or <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;zerophase&quot;</span></code> (default: <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;causal&quot;</span></code>).</p></li>
<li><p><strong>flashfftconv</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">bool</span></code>, <em>optional</em>) – An option to use <code class="code highlight python docutils literal highlight-python"><span class="n">FlashFFTConv</span></code> as a backend
(default: <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>).</p></li>
<li><p><strong>max_input_len</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">int</span></code>, <em>optional</em>) – When <code class="code highlight python docutils literal highlight-python"><span class="n">flashfftconv</span></code> is set to <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>,
the max input length must be also given (default: <code class="code highlight python docutils literal highlight-python"><span class="mi">2</span><span class="o">**</span><span class="mi">17</span></code>).</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.convolution.FIRConvolution.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_signals</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fir</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.convolution.FIRConvolution.forward" title="Link to this definition"></a></dt>
<dd><p>Performs the convolution operation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_signals</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times C_\mathrm{in} \times L_\mathrm{in}\)</span>) – A batch of input audio signals.</p></li>
<li><p><strong>fir</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times C_\mathrm{filter} \times L_\mathrm{filter}\)</span>) – A batch of FIR filters.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A batch of convolved signals of shape <span class="math notranslate nohighlight">\(B \times C_\mathrm{out} \times L_\mathrm{in}\)</span> where <span class="math notranslate nohighlight">\(C_\mathrm{out} = \max (C_\mathrm{in}, C_\mathrm{filter})\)</span>.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="grafx.processors.core.fft_filterbank.TriangularFilterBank">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">TriangularFilterBank</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">num_frequency_bins</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_filters</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">50</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'bark_traunmuller'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f_min</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">40</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f_max</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sr</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">44100</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">low_half_triangle</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.fft_filterbank.TriangularFilterBank" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>Creates a triangular filterbank for the given frequency range.
Code adapted from <a class="reference external" href="https://pytorch.org/audio/stable/generated/torchaudio.functional.melscale_fbanks.html#torchaudio.functional.melscale_fbanks">torchaudio</a>
and <a class="reference external" href="https://github.com/sai-soum/Diff-MST/blob/main/mst/filter.py">Diff-MST</a>.</p>
<blockquote>
<div><p>We provide both analysis and synthesis mode.
For the synthesis mode, we expand the input energy <span class="math notranslate nohighlight">\(\mathbf{E}_\mathrm{fb} \in \mathbb{R}^{B \times F_{\mathrm{fb}}}\)</span>
with the number of filterbanks <span class="math notranslate nohighlight">\(F_\mathrm{fb}\)</span> to the linear FFT scale <span class="math notranslate nohighlight">\(\mathbf{E} \in \mathbb{R}^{B \times F}\)</span>.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
\mathbf{E} = \mathbf{E}_\mathrm{fb} \mathbf{W}_\mathrm{fb}
\]</div>
</div>
</p>
<p><span class="math notranslate nohighlight">\(\smash{\mathbf{W}_\mathrm{fb} \in \mathbb{R}^{F \times F_{\mathrm{fb}}}}\)</span> is the standard trainagular filterbank matrix.
The analysis mode downsamples the frequency axis by multiplying the normalized filterbank matrix
(sum of each filterbank is 1; hence an adaptive weighted average pooling).</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>num_frequency_bins</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">int</span></code>) – Number of frequency bins from linear FFT.</p></li>
<li><p><strong>num_filters</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">int</span></code>) – Number of the filterbank filters.</p></li>
<li><p><strong>scale</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">str</span></code>, <em>optional</em>) – Frequency scale to use: <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;bark_traunmuller&quot;</span></code>, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;bark_schroeder&quot;</span></code>, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;bark_wang&quot;</span></code>, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;mel_htk&quot;</span></code>, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;mel_slaney&quot;</span></code>, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;linear&quot;</span></code>, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;log&quot;</span></code> (default: <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;bark_traunmuller&quot;</span></code>).</p></li>
<li><p><strong>f_min</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">float</span></code>, <em>optional</em>) – Minimum frequency (default: <code class="code highlight python docutils literal highlight-python"><span class="mi">40</span></code>).</p></li>
<li><p><strong>f_max</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">float</span></code>, <em>optional</em>) – Maximum frequency (default: <code class="code highlight python docutils literal highlight-python"><span class="kc">None</span></code>).</p></li>
<li><p><strong>low_half_triangle</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">bool</span></code>, <em>optional</em>) – Attach the remaining low-freq parts (default: <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>).</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.fft_filterbank.TriangularFilterBank.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">energy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'synthesis'</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.fft_filterbank.TriangularFilterBank.forward" title="Link to this definition"></a></dt>
<dd><p>Apply the filterbank to the energy tensor.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>energy</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B\times F \:\!\)</span>) – A batch of energy tensors.</p></li>
<li><p><strong>mode</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">str</span></code>, <em>optional</em>) – Mode of operation: <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;analysis&quot;</span></code> or <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;synthesis&quot;</span></code> (default: <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;synthesis&quot;</span></code>).</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The energy tensor after applying the filterbank.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.fft_filterbank.TriangularFilterBank.compute_matrix">
<em class="property"><span class="pre">static</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">compute_matrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">num_frequency_bins</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">num_filters</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scale</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f_min</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f_max</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sr</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">low_half_triangle</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.fft_filterbank.TriangularFilterBank.compute_matrix" title="Link to this definition"></a></dt>
<dd><p>Compute the triangular filterbank matrix
<span class="math notranslate nohighlight">\(\smash{\mathbf{W}_\mathrm{fb} \in \mathbb{R}^{F \times F_{\mathrm{fb}}}}\)</span>.</p>
</dd></dl>

</dd></dl>

<dl class="py class" id="module-grafx.processors.core.iir">
<dt class="sig sig-object py" id="grafx.processors.core.iir.IIRFilter">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">IIRFilter</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">order</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">2</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">backend</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fsm'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flashfftconv</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fsm_fir_len</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4000</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fsm_max_input_len</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">131072</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fsm_regularization</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.iir.IIRFilter" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>A serial stack of second-order filters (biquads) with the given coefficients.</p>
<blockquote>
<div><p>The transfer function of the <span class="math notranslate nohighlight">\(K\)</span> stacked biquads <span class="math notranslate nohighlight">\(H(z)\)</span> is given as <span id="id2">[<a class="reference internal" href="../references/reference.html#id160" title="Julius Orion Smith. Introduction to digital filters: with audio applications. Volume 2. Julius Smith, 2007.">Smi07b</a>]</span>
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
H(z) = \prod_{k=1}^K H_k(z) = \prod_k \frac{ b_{k, 0} + b_{k, 1} z^{-1} + b_{i, 2} z^{-2}}{a_{i, 0} + a_{i, 1} z^{-1} + a_{i, 2} z^{-2}}.
\]</div>
</div>
</p>
<p>We provide three backends for the filtering.
The first one, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;lfilter&quot;</span></code>, is the time-domain method that computes the difference equation exactly.
It uses <code class="code highlight python docutils literal highlight-python"><span class="n">torchaudio</span><span class="o">.</span><span class="n">lfilter</span></code>, which uses the direct form I implementation
(the bar denotes the normalized coefficients by <span class="math notranslate nohighlight">\(a_{i, 0}\)</span>) <span id="id3">[<a class="reference internal" href="../references/reference.html#id158" title="Chin-Yun Yu, Christopher Mitcheltree, Alistair Carson, Stefan Bilbao, Joshua D Reiss, and György Fazekas. Differentiable all-pole filters for time-varying audio systems. arXiv preprint arXiv:2404.07970, 2024.">YMC+24</a>]</span>.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}
x[n] &amp;= \bar{b}_{i, 0} s[n] + \bar{b}_{i, 1} s[n-1] + \bar{b}_{i, 2} s[n-2], \\
y_i[n] &amp;= x[n] - \bar{a}_{i, 1} y[n-1] - \bar{a}_{i, 2} y[n-2]
\end{split}\]</div>
</div>
</p>
<p>The second one, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;fsm&quot;</span></code>, is the frequency-sampling method (FSM) that approximates the filter with a finite impulse response (FIR)
by sampling the discrete-time Fourier transform (DTFT) of the filter <span class="math notranslate nohighlight">\(H(e^{j\omega})\)</span> at a finite number of points <span class="math notranslate nohighlight">\(N\)</span> uniformly
<span id="id4">[<a class="reference internal" href="../references/reference.html#id74" title="Boris Kuznetsov, Julian D Parker, and Fabián Esqueda. Differentiable iir filters for machine learning applications. In Proc. Int. Conf. Digital Audio Effects (eDAFx-20), 297–303. 2020.">KPE20</a>, <a class="reference internal" href="../references/reference.html#id12" title="L. Rabiner, B. Gold, and C. McGonegal. An approach to the approximation problem for nonrecursive digital filters. IEEE Transactions on Audio and Electroacoustics, 18(2):83-106, 1970.">RGM70</a>]</span>.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
H_N[k]
= \prod_{i=1}^K (H_i)_N[k]
= \prod_{i=1}^K \frac{b_{i, 0} + b_{i, 1} z_N^{-1} + b_{i, 2} z_N^{-2}}{a_{i, 0} + a_{i, 1} z_N^{-1} + a_{i, 2} z_N^{-2}}.
\]</div>
</div>
</p>
<p>Here, <span class="math notranslate nohighlight">\(z_N = \exp(j\cdot 2\pi/N)\)</span> so that <span class="math notranslate nohighlight">\(z_N^k\)</span> becomes the <span class="math notranslate nohighlight">\(k\)</span>-th <span class="math notranslate nohighlight">\(N\)</span>-point discrete Fourier transform (DFT) bin.
Then, the FIR filter <span class="math notranslate nohighlight">\(h_N[n]\)</span> is obtained by taking the inverse DFT of the sampled DTFT <span class="math notranslate nohighlight">\(H_N[k]\)</span>
and the final output signal is computed by convolving the input signal with the FIR filter as <span class="math notranslate nohighlight">\(y[n] = h_N[n] * s[n]\)</span>.
This <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;fsm&quot;</span></code> backend is faster than the former <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;lfilter&quot;</span></code> but only an approximation.
This error is called time-domain aliasing; the frequency-sampled FIR is given as follows <span id="id5">[<a class="reference internal" href="../references/reference.html#id162" title="Julius O Smith. Mathematics of the discrete Fourier transform (DFT): with audio applications. Julius Smith, 2007.">Smi07a</a>]</span>.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
h_N[n] = \sum_{m=0}^\infty h[n+mN].
\]</div>
</div>
</p>
<p>where <span class="math notranslate nohighlight">\(h[n]\)</span> is the true infinite impulse response (IIR). Clearly, increasing the number of samples <span class="math notranslate nohighlight">\(N\)</span> reduces the error.</p>
<p>The third one, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;ssm&quot;</span></code>, is based on the diagonalisation of the state-space model (SSM) of the biquad filter so it only works for the second-order filters.
The direct form II implementation of the biquad filter can be written in state-space form <span id="id6">[<a class="reference internal" href="../references/reference.html#id160" title="Julius Orion Smith. Introduction to digital filters: with audio applications. Volume 2. Julius Smith, 2007.">Smi07b</a>]</span> as
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}
x_i[n+1] &amp;= A_i x_i[n] + B_i s[n], \\
y_i[n] &amp;= C_i x_i[n] + \bar{b}_{i, 0} s[n],
\end{split}\]</div>
</div>

<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}
A_i = \begin{bmatrix}-\bar{a}_{i, 1} &amp; -\bar{a}_{i, 2} \\ 1 &amp; 0 \end{bmatrix}, \quad
B_i &amp;= \begin{bmatrix}1 \\ 0 \end{bmatrix}, \quad
C_i = \begin{bmatrix}\bar{b}_{i, 1} - \bar{b}_{i, 0} \bar{a}_{i, 1} &amp; \bar{b}_{i, 2} - \bar{b}_{i, 0} \bar{a}_{i, 2} \end{bmatrix}.
\end{split}\]</div>
</div>

If the poles of the filter are unique, the transition matrix <span class="math notranslate nohighlight">\(A_i\)</span> can be decomposed as <span class="math notranslate nohighlight">\(A_i = V_i \Lambda_i V_i^{-1}\)</span> where <span class="math notranslate nohighlight">\(\Lambda_i\)</span> is either a diagonal matrix with real poles on the diagonal or a scaled rotation matrix, which can be represented by one of the complex conjugate poles.
Using this decomposition, the filter can be implemented as first-order recursive filters on the projected siganl <span class="math notranslate nohighlight">\(V_i^{-1} B_i s[n]\)</span>, where we leverage <cite>Parallel Scan</cite> <span id="id7">[<a class="reference internal" href="../references/reference.html#id167" title="Eric Martin and Chris Cundy. Parallelizing linear recurrent neural nets over sequence length. In International Conference on Learning Representations. 2018.">MC18</a>]</span> to speed up the computation on the GPU.
Finally, the output is projected back to the original basis using <span class="math notranslate nohighlight">\(V_i\)</span>.</p>
<p>We recommend using the <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;ssm&quot;</span></code> over the <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;lfilter&quot;</span></code> backend in general, not only because it runs several times faster on the GPU but it’s more numerically stable.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>num_filters</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">int</span></code>, <em>optional</em>) – Number of biquads to use (default: <code class="code highlight python docutils literal highlight-python"><span class="mi">1</span></code>).</p></li>
<li><p><strong>normalized</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">bool</span></code>, <em>optional</em>) – If set to <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>, the filter coefficients are assumed to be normalized by <span class="math notranslate nohighlight">\(a_{i, 0}\)</span>,
making the number of learnable parameters <span class="math notranslate nohighlight">\(5\)</span> per biquad instead of <span class="math notranslate nohighlight">\(6\)</span>
(default: <code class="code highlight python docutils literal highlight-python"><span class="kc">False</span></code>).</p></li>
<li><p><strong>backend</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">str</span></code>, <em>optional</em>) – The backend to use for the filtering, which can either be the frequency-sampling method <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;fsm&quot;</span></code>
or exact time-domain filters, <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;lfilter&quot;</span></code> or <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;ssm&quot;</span></code> (default: <code class="code highlight python docutils literal highlight-python"><span class="s2">&quot;fsm&quot;</span></code>).</p></li>
<li><p><strong>fsm_fir_len</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">int</span></code>, <em>optional</em>) – The length of FIR approximation when <code class="code highlight python docutils literal highlight-python"><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;fsm&quot;</span></code> (default: <code class="code highlight python docutils literal highlight-python"><span class="mi">8192</span></code>).</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.iir.IIRFilter.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_signal</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">Bs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">As</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.iir.IIRFilter.forward" title="Link to this definition"></a></dt>
<dd><p>Apply the IIR filter to the input signal and the given coefficients.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_signal</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times C_\mathrm{in} \times L\)</span>) – A batch of input audio signals.</p></li>
<li><p><strong>Bs</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times C_\mathrm{filter} \times K \times 3\)</span>) – A batch of biquad coefficients, <span class="math notranslate nohighlight">\(b_{i, 0}, b_{i, 1}, b_{i, 2}\)</span>, stacked in the last dimension.</p></li>
<li><p><strong>As</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times C_\mathrm{filter} \times K \times 3\)</span>) – A batch of biquad coefficients, <span class="math notranslate nohighlight">\(b_{i, 0}, b_{i, 1}, b_{i, 2}\)</span>, stacked in the last dimension.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="grafx.processors.core.delay.SurrogateDelay">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">SurrogateDelay</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">N</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">straight_through</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">radii_loss</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalize_gradients</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.delay.SurrogateDelay" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>A surrogate FIR processor for a learnable delay line.</p>
<blockquote>
<div><p>A single delay can be represented as a FIR filter
<span class="math notranslate nohighlight">\(
h[n] = \delta[n-d]
\)</span>
where <span class="math notranslate nohighlight">\(0\leq d &lt; N\)</span> is a delay length we want to optimize and <span class="math notranslate nohighlight">\(\delta[n]\)</span> denotes a unit impulse.
We exploit the fact that each delay corresponds to a complex sinusoid in the frequency domain.
Such a sinusoid’s angular frequency <span class="math notranslate nohighlight">\(z \in \mathbb{C}\)</span> can be optimized with the gradient descent
if we allow it to be inside the unit disk, i.e., <span class="math notranslate nohighlight">\(|z| \leq 1\)</span> <span id="id8">[<a class="reference internal" href="../references/reference.html#id85" title="Ben Hayes, Charalampos Saitis, and György Fazekas. Sinusoidal frequency estimation by gradient descent. In IEEE ICASSP, 1–5. 2023.">HSF23</a>]</span>.
We first start with an unconstrained complex parameter <span class="math notranslate nohighlight">\(\tilde{z} \in \mathbb{C}\)</span>
and restrict it to be inside the unit disk (in the same way of restricting the poles <span id="id9">[<a class="reference internal" href="../references/reference.html#id11" title="Shahan Nercessian, Andy Sarroff, and Kurt James Werner. Lightweight and interpretable neural modeling of an audio distortion effect using hyperconditioned differentiable biquads. In ICASSP 2021-2021 IEEE International Conference on Acoustics, Speech and Signal Processing (ICASSP), 890–894. IEEE, 2021.">NSW21</a>]</span>)
with the following activation function.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
z = \tilde{z}_k \cdot \frac{\tanh( | \tilde{z}_k | )}{ | \tilde{z}_k | + \epsilon}.
\]</div>
</div>
</p>
<p>Then, we compute a damped sinusoid with the normalized frequency <span class="math notranslate nohighlight">\(z\)</span> then use its inverse FFT as a surrogate of the delay.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
\tilde{h}[n] = \frac{1}{N} \sum_{k=0}^{N-1} z^k z_N^{kn}.
\]</div>
</div>
</p>
<p>where <span class="math notranslate nohighlight">\(z_{N} = \exp(j\cdot 2\pi/N)\)</span>.
Clearly, it is not a sparse delay line unless <span class="math notranslate nohighlight">\(z\)</span> is an integer power of <span class="math notranslate nohighlight">\(z_N\)</span> (on the unit circle with an exact angle).
Instead it becomes a time-aliased and low-passed sinc kernel.
We can use this soft delay as is, or we can use straight-through estimation (STE) <span id="id10">[<a class="reference internal" href="../references/reference.html#id13" title="Yoshua Bengio, Nicholas Leonard, and Aaron Courville. Estimating or propagating gradients through stochastic neurons for conditional computation. arXiv:1308.3432, 2013.">BLC13</a>]</span>
so that the forward pass uses the hard delays <span class="math notranslate nohighlight">\(h[n]\)</span> and the backward pass uses the soft delays <span class="math notranslate nohighlight">\(\smash{\tilde{h}[n]}\)</span>.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
\frac{\partial L}{\partial z^*} \leftarrow \sum_{n=0}^{N-1} \frac{\partial L}{\partial h[n]} \frac{\partial \tilde{h}[n]}{\partial z^*}
\]</div>
</div>
</p>
<p>For a stable and faster convergence, we provide two additional options.
The first one is to normalize the gradients of the complex conjugate to have a unit norm.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
\frac{\partial L}{\partial z^*} \leftarrow \frac{\partial L}{\partial z^*}/ \left|\frac{\partial L}{\partial z^*} \right|.
\]</div>
</div>
</p>
<p>The second one is to use the radii loss
<span class="math notranslate nohighlight">\(L_{\mathrm{radii}} = (1 - | z | )^2\)</span>
to encourage complex angluar frequency <span class="math notranslate nohighlight">\(z\)</span> to be near the unit circle, making the delays to be “sharp.”
We empirically found this regularization to be helpful especially when we use the STE as it alleviates the discrepancy between the hard and soft delays
while still having the benefits of the soft FIR.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>N</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">int</span></code>) – The length surrogate FIR, which is also the largest delay length minus one.</p></li>
<li><p><strong>straight_through</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">bool</span></code>, <em>optional</em>) – Use hard delays for the forward passes and surrogate soft delays for the backward passes
with straight-through estimation
(default: <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>).</p></li>
<li><p><strong>normalize_gradients</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">bool</span></code>, <em>optional</em>) – Normalize the complex conjugate gradients to unit norm
(default: <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>).</p></li>
<li><p><strong>radii_loss</strong> (<code class="code highlight python docutils literal highlight-python"><span class="nb">bool</span></code>, <em>optional</em>) – Use the radii loss to encourage the delays to be close to the unit circle
(default: <code class="code highlight python docutils literal highlight-python"><span class="kc">True</span></code>).</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.delay.SurrogateDelay.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">z</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.delay.SurrogateDelay.forward" title="Link to this definition"></a></dt>
<dd><p>Computes the surrogate delay FIRs from the complex angular frequencies.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>z</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">ComplexTensor</span></code>, <em>any shape</em>) – The unnormalized complex angular frequencies.</p>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A batch of FIRs either hard (when using the straight-through estimation) of soft surrogate delays.
The returned tensor has an additional dimension (last) for the FIR taps.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code> <em>or</em> <code class="code highlight python docutils literal highlight-python"><span class="n">Tuple</span><span class="p">[</span><span class="n">FloatTensor</span><span class="p">,</span> <span class="n">FloatTensor</span><span class="p">]</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="grafx.processors.core.envelope.TruncatedOnePoleIIRFilter">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">TruncatedOnePoleIIRFilter</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iir_len</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">16384</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">backend_kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.envelope.TruncatedOnePoleIIRFilter" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>A one-pole IIR filter with a truncated impulse response.</p>
<blockquote>
<div><p>The true one-pole IIR filter is defined as a recursive filter with a coefficient <span class="math notranslate nohighlight">\(\alpha\)</span>.
Here, for the speed-up, we calculate its truncated impulse response analytically and convolve it to the input signal.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[
y[n] \approx u[n] * (1-\alpha)\alpha^n.
\]</div>
</div>
</p>
<p>The length of the truncated FIR, <span class="math notranslate nohighlight">\(N\)</span>, is given as an argument <code class="code highlight python docutils literal highlight-python"><span class="n">iir_len</span></code>.</p>
</div></blockquote>
<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.envelope.TruncatedOnePoleIIRFilter.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_signals</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">z_alpha</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.envelope.TruncatedOnePoleIIRFilter.forward" title="Link to this definition"></a></dt>
<dd><p>Processes input audio with the processor and given coefficients.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_signals</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times L\)</span>) – A batch of input audio signals.</p></li>
<li><p><strong>z_alpha</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times 1\)</span>) – A batch of one-pole coefficients.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A batch of smoothed signals of shape <span class="math notranslate nohighlight">\(B \times L\)</span>.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="grafx.processors.core.envelope.Ballistics">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Ballistics</span></span><a class="headerlink" href="#grafx.processors.core.envelope.Ballistics" title="Link to this definition"></a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">Module</span></code></p>
<p>A ballistics processor that smooths the input signal with a recursive filter.</p>
<blockquote>
<div><p>An input signal <span class="math notranslate nohighlight">\(u[n]\)</span> is smoothed with recursively, with a different coefficient for an “attack” and “release”.
<div class="math-wrapper docutils container">
<div class="math notranslate nohighlight">
\[\begin{split}
y[n] = \begin{cases}
\alpha_\mathrm{R} y[n-1]+(1-\alpha_\mathrm{R}) u[n] &amp; u[n] &lt; y[n-1], \\
\alpha_\mathrm{A} y[n-1]+(1-\alpha_\mathrm{A}) u[n] &amp; u[n] \geq y[n-1]. \\
\end{cases}
\end{split}\]</div>
</div>
</p>
<p>We calculate the coefficients from the inputs with the sigmoid function, i.e.,
<span class="math notranslate nohighlight">\(\alpha_\mathrm{A} = \sigma(z_{\mathrm{A}})\)</span> and <span class="math notranslate nohighlight">\(\alpha_\mathrm{R} = \sigma(z_{\mathrm{R}})\)</span>.
We use <code class="code highlight python docutils literal highlight-python"><span class="n">diffcomp</span></code> for the optimized forward and backward computation <span id="id11">[<a class="reference internal" href="../references/reference.html#id158" title="Chin-Yun Yu, Christopher Mitcheltree, Alistair Carson, Stefan Bilbao, Joshua D Reiss, and György Fazekas. Differentiable all-pole filters for time-varying audio systems. arXiv preprint arXiv:2404.07970, 2024.">YMC+24</a>]</span>.</p>
</div></blockquote>
<dl class="py method">
<dt class="sig sig-object py" id="grafx.processors.core.envelope.Ballistics.forward">
<span class="sig-name descname"><span class="pre">forward</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">input_signals</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">z_alpha</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#grafx.processors.core.envelope.Ballistics.forward" title="Link to this definition"></a></dt>
<dd><p>Processes input audio with the processor and given coefficients.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>input_signals</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times L\)</span>) – A batch of input audio signals.</p></li>
<li><p><strong>z_alpha</strong> (<code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code>, <span class="math notranslate nohighlight">\(B \times 2\)</span>) – A batch of attack and release coefficients stacked in the last dimension.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>A batch of smoothed signals of shape <span class="math notranslate nohighlight">\(B \times L\)</span>.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="code highlight python docutils literal highlight-python"><span class="n">FloatTensor</span></code></p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="filter.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">grafx.processors.filter</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="../graph_api/utils.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">grafx.utils</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Sungho Lee
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">grafx.processors.core</a><ul>
<li><a class="reference internal" href="#grafx.processors.core.convolution.FIRConvolution"><code class="docutils literal notranslate"><span class="pre">FIRConvolution</span></code></a></li>
<li><a class="reference internal" href="#grafx.processors.core.fft_filterbank.TriangularFilterBank"><code class="docutils literal notranslate"><span class="pre">TriangularFilterBank</span></code></a></li>
<li><a class="reference internal" href="#grafx.processors.core.iir.IIRFilter"><code class="docutils literal notranslate"><span class="pre">IIRFilter</span></code></a></li>
<li><a class="reference internal" href="#grafx.processors.core.delay.SurrogateDelay"><code class="docutils literal notranslate"><span class="pre">SurrogateDelay</span></code></a></li>
<li><a class="reference internal" href="#grafx.processors.core.envelope.TruncatedOnePoleIIRFilter"><code class="docutils literal notranslate"><span class="pre">TruncatedOnePoleIIRFilter</span></code></a></li>
<li><a class="reference internal" href="#grafx.processors.core.envelope.Ballistics"><code class="docutils literal notranslate"><span class="pre">Ballistics</span></code></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>